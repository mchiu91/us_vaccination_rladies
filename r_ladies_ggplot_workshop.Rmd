---
title: "Mapping US Vaccination Data in R"
author: "Michelle Chiu"
date: "7/6/2021"
output: html_document
---

```{r setup, message = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Packages

```{r packages, message = FALSE}
# install any missing packages as needed
# install.packages(c("readr", "tidyverse", "ggplot2", "viridis", "choroplethr"))

# load packages
library(readr)
library(tidyverse)
library(ggplot2)
library(viridis)
library(choroplethr)
# library(choroplethrMaps)
```

## Dataset

You can find the dataset **us_state_vaccinations.csv** inside the _data_ folder or download it directly from [Data on COVID-19 vaccinations by Our World in Data](https://github.com/owid/covid-19-data).

### Importing and Cleaning the data

After importing the raw data, filter by _date_, then select the relevant variables _location_ and _people_fully_vaccinated_per_hundred_ and assign to a new object **today_covid**.
Read in our US state data and assign it to an object **us_map**, which has _long_ and _lat_ (longitude and latitude) variables used in outlining our US state map.

```{r data, message = FALSE}
# read covid-19 dataset into R and assign it to an object
covid_raw <- read_csv("data/us_state_vaccinations.csv")
# head(covid_raw)

# filter by date and select relevant variables
today_covid <- 
  covid_raw %>% 
  filter(date=='2021-06-28') %>% 
  select(location, people_fully_vaccinated_per_hundred)
head(today_covid)

# map_data function from 'ggplot2' uses name of map provided by 'maps' package
# import us state map and assign it to an object
us_map <- map_data("state")
head(us_map) # peek at the us state map data
```

Next, we will tweak the _location_ variables from the COVID-19 dataset **today_covid** so they match **us_map**, then merge by region to make our final 'master' data **today_covid_map** that will be used in plotting.

```{r maps, message = FALSE}
# convert states to lowercase to match reference map
today_covid$location <- tolower(today_covid$location)

# rename column names and ny state to match reference map
colnames(today_covid) <- c('region','value')
today_covid$region <- 
  plyr::revalue(today_covid$region, c("new york state" = "new york"))

# merge vaccination data with map long/lat columns
today_covid_map <- merge(us_map, today_covid, by = "region")
```

## Data Visualization using _ggplot2_ package

```{r plot-1, warning = FALSE}
covid_map_1 <- ggplot(data = today_covid_map, 
                      aes(x = long, y = lat)) + 
  geom_map(data = today_covid_map, map = us_map, 
           aes(fill = value, map_id = region), color = "white") +
  scale_fill_viridis(name = "fully vaccinated per 100 population", option = "D") +
  theme_void() +
  labs(title = "State-by-state Vaccination Across the US",
       subtitle = "Data from the Centers for Disease Control and Prevention (June 28th, 2021)") +
  theme(text = element_text(size = 20),
        legend.title = element_text(size = 14),
        legend.position = 'right')

covid_map_1
```

## Data Visualization using _choroplethr_ package

```{r plot-2, warning = FALSE}
## Data Visualization using choroplethr

# example using existing data from base R
# data(df_pop_state)
# state_choropleth(df_pop_state,
#                  title  = "US 2012 State Population Estimates", 
#                  legend = "Population")

# us vaccination
covid_map_2 <- state_choropleth(today_covid,
                                title = "State-by-state vaccination across the US",
                                legend = "Fully vaccinated per 100 population",
                                num_colors = 1)
covid_map_2
# 5 quantiles, zoom in on vector of states
# state_choropleth(today_covid, num_colors = 5,
#                  zoom = c("new york", "pennsylvania", "new jersey"))
```

## Built-in Challenge: Choose your own adventure
We'll be using built-in state dataset **state.x77** from Base R (R documentation [here](https://www.rdocumentation.org/packages/datasets/versions/3.6.2/topics/state))
```{r builtin-challenge, message = FALSE}
# Take the state.x77 data and use either/both 
# ggplot2 and choropleth to make a plot

# Example
# take the state.x77 matrix, make it into
# something that state_choropleth can use
state_murder_plot <- as.data.frame(state.x77[,"Murder",drop=F]) %>%
  rownames_to_column("region") %>%
  rename(value = Murder) %>%
  mutate(region = tolower(region))


```